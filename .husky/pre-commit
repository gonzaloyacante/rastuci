#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ         ๐ RASTUCI PRE-COMMIT VERIFICATION SUITE            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# Verificar que estamos en el workspace correcto
if [ ! -f "package.json" ]; then
  echo "โ Error: package.json no encontrado. Ejecutar desde la raรญz del proyecto."
  exit 1
fi

# Track start time
START_TIME=$(date +%s)

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# STEP 1: LINT-STAGED (formato y linting de archivos modificados)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ [1/5] Lint-Staged: Formateando archivos modificados..."
if ! npx lint-staged; then
  echo "โ Error en lint-staged. Revisa errores de formato/linting."
  exit 1
fi
echo "โ Lint-staged completado"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# STEP 2: TYPESCRIPT TYPE CHECKING (compilaciรณn sin emitir)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ [2/5] TypeScript: Verificando tipos..."
if ! npx tsc --noEmit; then
  echo "โ Error en type checking. Revisa errores de TypeScript."
  exit 1
fi
echo "โ TypeScript type check completado"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# STEP 3: ESLINT (errores crรญticos)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐งน [3/5] ESLint: Verificando cรณdigo..."
if ! npx eslint "src/**/*.{ts,tsx}" --quiet; then
  echo "โ Error en ESLint. Revisa errores."
  exit 1
fi
echo "โ ESLint completado sin errores"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# STEP 4: PRISMA VALIDATION (schema correcto)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐๏ธ  [4/5] Prisma: Validando schema..."
if [ -f "prisma/schema.prisma" ]; then
  if ! npx prisma validate; then
    echo "โ Error en Prisma schema. Revisa prisma/schema.prisma."
    exit 1
  fi
  echo "โ Prisma schema vรกlido"
else
  echo "โน๏ธ  No se encontrรณ schema de Prisma, saltando..."
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# STEP 5: NEXT.JS BUILD (verificaciรณn de producciรณn)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐๏ธ  [5/5] Next.js: Verificando build de producciรณn..."
if ! npx next build; then
  echo "โ Error en build de Next.js. El cรณdigo no compila correctamente."
  exit 1
fi
echo "โ Build de producciรณn exitoso"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# STEP 6: SECURITY AUDIT (vulnerabilidades crรญticas) - OPCIONAL
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ [Bonus] Security: Verificando vulnerabilidades crรญticas..."
# Solo avisar, no fallar - algunas dependencias tienen issues conocidos
yarn audit --level critical 2>/dev/null || echo "โ๏ธ  Hay vulnerabilidades crรญticas (revisar despuรฉs del commit)"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# VERIFICACIONES FINALES
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "โ๏ธ  Verificando archivos de configuraciรณn..."
CONFIG_OK=true
for config_file in "next.config.ts" "tsconfig.json" "package.json" "tailwind.config.ts"; do
  if [ -f "$config_file" ]; then
    echo "  โ $config_file"
  else
    echo "  โ $config_file faltante!"
    CONFIG_OK=false
  fi
done

if [ "$CONFIG_OK" = false ]; then
  echo "โ Archivos de configuraciรณn faltantes."
  exit 1
fi

# Calcular tiempo total
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ     โ TODAS LAS VERIFICACIONES COMPLETADAS EXITOSAMENTE    โ"
echo "โ                   Tiempo total: ${DURATION}s                        โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ฆ Listo para commit seguro. ยกCรณdigo de calidad garantizada!"
