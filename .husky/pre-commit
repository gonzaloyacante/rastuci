#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Iniciando pre-commit hooks..."

# Verificar que estamos en el workspace correcto
if [ ! -f "package.json" ]; then
  echo "âŒ Error: package.json no encontrado. Ejecutar desde la raÃ­z del proyecto."
  exit 1
fi

# 1. Ejecutar lint-staged para archivos staged
echo "ğŸ“‹ Ejecutando lint-staged para archivos modificados..."
if ! npx lint-staged; then
  echo "âŒ Error en lint-staged. Revisa los errores de formato/linting."
  exit 1
fi

# 2. Type checking completo con TypeScript
echo "ğŸ” Verificando tipos TypeScript..."
if ! npm run type-check; then
  echo "âŒ Error en type checking. Revisa los errores de TypeScript."
  exit 1
fi

# 3. Linting estricto (cero warnings)
echo "ğŸ§¹ Ejecutando linting estricto..."
if ! npm run lint:strict; then
  echo "âŒ Error en linting estricto. Revisa warnings/errores de ESLint."
  exit 1
fi

# 4. Verificar build sin errores
echo "ï¿½ Verificando build de Next.js..."
if ! npm run build:check; then
  echo "âŒ Error en build verification. El cÃ³digo no compila correctamente."
  exit 1
fi

# 5. Ejecutar tests si existen
if [ -d "src/__tests__" ] || [ -d "tests" ]; then
  echo "ğŸ§ª Ejecutando tests..."
  if ! npm test -- --run; then
    echo "âŒ Error en tests. Algunos tests estÃ¡n fallando."
    exit 1
  fi
else
  echo "â„¹ï¸  No se encontraron directorios de tests, saltando tests..."
fi

# 6. Verificar que no hay archivos de configuraciÃ³n corruptos
echo "âš™ï¸  Verificando archivos de configuraciÃ³n..."
if [ -f "next.config.ts" ]; then
  echo "âœ“ next.config.ts existe"
fi
if [ -f "tsconfig.json" ]; then
  echo "âœ“ tsconfig.json existe"
fi

echo "âœ… Todos los pre-commit checks completados exitosamente!"
echo "ğŸ“¦ Listo para commit seguro."
