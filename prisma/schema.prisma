generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// AUTHENTICATION & USER MODELS
// =============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SessionLog {
  id        String    @id @default(cuid())
  userId    String
  ipAddress String?
  userAgent String?
  loginAt   DateTime  @default(now())
  logoutAt  DateTime?
  isActive  Boolean   @default(true)
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([loginAt])
  @@index([userId])
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String?      @unique
  emailVerified DateTime?
  image         String?
  password      String?
  isAdmin       Boolean      @default(false)
  createdAt     DateTime     @default(now())
  lastLoginAt   DateTime?
  lastLoginIp   String?
  loginCount    Int          @default(0)
  updatedAt     DateTime     @updatedAt
  Account       Account[]
  Session       Session[]
  SessionLog    SessionLog[]

  @@index([email])
  @@index([isAdmin])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@index([expires])
}

// =============================================================================
// LEGAL & CONTENT MODELS
// =============================================================================

model LegalPolicy {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  content     Json
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// =============================================================================
// ANALYTICS MODELS
// =============================================================================

model analytics_events {
  id                 String             @id @default(cuid())
  sessionId          String
  userId             String?
  eventName          String
  eventData          Json?
  pageUrl            String?
  referrer           String?
  deviceType         String?
  browser            String?
  os                 String?
  country            String?
  city               String?
  createdAt          DateTime           @default(now())
  analytics_sessions analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([eventName])
  @@index([sessionId])
  @@index([userId])
  @@index([eventName, createdAt])
}

model analytics_sessions {
  id               String             @id @default(cuid())
  userId           String?
  startedAt        DateTime           @default(now())
  endedAt          DateTime?
  pageViews        Int                @default(0)
  deviceType       String?
  browser          String?
  os               String?
  screenWidth      Int?
  screenHeight     Int?
  country          String?
  city             String?
  timezone         String?
  entryPage        String?
  exitPage         String?
  duration         Int?
  isConverted      Boolean            @default(false)
  conversionValue  Decimal?           @db.Decimal(10, 2)
  analytics_events analytics_events[]
  cart_abandonment cart_abandonment[]
  search_analytics search_analytics[]

  @@index([isConverted])
  @@index([startedAt])
  @@index([userId])
  @@index([isConverted, startedAt])
}

model search_analytics {
  id                  String             @id @default(cuid())
  sessionId           String
  userId              String?
  query               String
  resultsCount        Int?
  clickedProductId    String?
  clickPosition       Int?
  convertedToCart     Boolean            @default(false)
  convertedToPurchase Boolean            @default(false)
  createdAt           DateTime           @default(now())
  analytics_sessions  analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([query])
  @@index([sessionId])
  @@index([convertedToPurchase, createdAt])
}

model cart_abandonment {
  id                 String             @id @default(cuid())
  sessionId          String
  userId             String?
  cartItems          Json
  cartValue          Decimal            @db.Decimal(10, 2)
  abandonedAt        DateTime           @default(now())
  lastStep           String?
  recoveredAt        DateTime?
  recoveryOrderId    String?
  emailSent          Boolean            @default(false)
  emailSentAt        DateTime?
  analytics_sessions analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([abandonedAt])
  @@index([recoveredAt])
  @@index([sessionId])
  @@index([userId])
  @@index([emailSent, abandonedAt])
}

// =============================================================================
// CORREO ARGENTINO MODELS
// =============================================================================

model ca_agencies {
  code               String   @id
  name               String
  manager            String?
  email              String?
  phone              String?
  packageReception   Boolean  @default(false)
  pickupAvailability Boolean  @default(false)
  streetName         String?
  streetNumber       String?
  floor              String?
  apartment          String?
  locality           String?
  city               String?
  province           String?
  provinceCode       String   @db.Char(1)
  postalCode         String?
  latitude           Float?
  longitude          Float?
  hours              Json?
  status             String   @default("ACTIVE")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([city])
  @@index([provinceCode])
  @@index([status])
  @@index([postalCode])
}

model ca_customers {
  customerId        String              @id
  firstName         String
  lastName          String
  email             String              @unique
  documentType      CADocumentType
  documentId        String              @unique
  phone             String?
  cellPhone         String?
  streetName        String?
  streetNumber      String?
  floor             String?
  apartment         String?
  locality          String?
  city              String?
  provinceCode      String?             @db.Char(1)
  postalCode        String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  ca_shipments      ca_shipments[]
  ca_shipping_rates ca_shipping_rates[]
  orders            orders[]

  @@index([documentId])
  @@index([email])
}

model ca_shipments {
  id                 String               @id @default(cuid())
  customerId         String
  extOrderId         String               @unique
  orderNumber        String?
  trackingNumber     String?              @unique
  productId          String?
  senderName         String?
  senderPhone        String?
  senderCellPhone    String?
  senderEmail        String?
  senderStreetName   String?
  senderStreetNumber String?
  senderFloor        String?
  senderApartment    String?
  senderLocality     String?
  senderCity         String?
  senderProvinceCode String?              @db.Char(1)
  senderPostalCode   String?
  recipientName      String
  recipientPhone     String?
  recipientCellPhone String?
  recipientEmail     String
  deliveryType       CADeliveryType
  productType        String
  agencyCode         String?
  destStreetName     String?
  destStreetNumber   String?
  destFloor          String?
  destApartment      String?
  destLocality       String?
  destCity           String?
  destProvinceCode   String?              @db.Char(1)
  destPostalCode     String?
  weight             Int
  height             Int
  width              Int
  length             Int
  declaredValue      Decimal              @db.Decimal(10, 2)
  status             String?
  importedAt         DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  ca_customers       ca_customers         @relation(fields: [customerId], references: [customerId])
  ca_tracking_events ca_tracking_events[]
  orders             orders[]

  @@index([customerId])
  @@index([extOrderId])
  @@index([status])
  @@index([trackingNumber])
  @@index([createdAt])
}

model ca_shipping_rates {
  id                    String         @id @default(cuid())
  customerId            String
  postalCodeOrigin      String
  postalCodeDestination String
  deliveryType          CADeliveryType
  productType           String
  productName           String
  weight                Int
  height                Int
  width                 Int
  length                Int
  price                 Decimal        @db.Decimal(10, 2)
  deliveryTimeMin       String
  deliveryTimeMax       String
  validTo               DateTime
  createdAt             DateTime       @default(now())
  ca_customers          ca_customers   @relation(fields: [customerId], references: [customerId])

  @@index([customerId])
  @@index([postalCodeDestination])
  @@index([postalCodeOrigin])
  @@index([validTo])
  @@index([postalCodeOrigin, postalCodeDestination])
}

model ca_tracking_events {
  id           String       @id @default(cuid())
  shipmentId   String
  event        String
  eventDate    DateTime
  branch       String
  status       String?
  sign         String?
  createdAt    DateTime     @default(now())
  ca_shipments ca_shipments @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([eventDate])
  @@index([event])
  @@index([shipmentId])
  @@index([shipmentId, eventDate])
}

// =============================================================================
// PRODUCT & CATEGORY MODELS
// =============================================================================

model categories {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  imageUrl    String?
  icon        String?
  products    products[]

  @@index([name])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model products {
  id                 String               @id @default(cuid())
  name               String
  description        String?
  price              Decimal              @db.Decimal(10, 2)
  stock              Int                  @default(0)
  images             String
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  categoryId         String
  onSale             Boolean              @default(false)
  colors             String[]             @default([])
  features           String[]             @default([])
  rating             Float?               @default(0)
  reviewCount        Int                  @default(0)
  sizes              String[]             @default([])
  salePrice          Decimal?             @db.Decimal(10, 2)
  weight             Int?                 @default(1000)
  height             Int?                 @default(10)
  width              Int?                 @default(20)
  length             Int?                 @default(30)
  sizeGuide          Json?
  colorImages        Json?
  order_items        order_items[]
  product_reviews    product_reviews[]
  product_variants   product_variants[]
  categories         categories           @relation(fields: [categoryId], references: [id])
  stock_reservations stock_reservations[]

  @@index([categoryId])
  @@index([categoryId, name])
  @@index([categoryId, onSale])
  @@index([categoryId, price])
  @@index([colors], type: Gin)
  @@index([createdAt])
  @@index([features], type: Gin)
  @@index([name])
  @@index([onSale])
  @@index([onSale, price])
  @@index([price])
  @@index([sizes], type: Gin)
  @@index([stock])
}

model product_variants {
  id        String   @id @default(cuid())
  productId String
  color     String
  size      String
  stock     Int      @default(0)
  sku       String?
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, color, size])
  @@index([productId])
  @@index([sku])
}

model product_reviews {
  id           String   @id @default(cuid())
  rating       Int      @db.SmallInt
  comment      String?
  customerName String
  createdAt    DateTime @default(now())
  productId    String
  products     products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@index([rating])
}

model stock_reservations {
  id        String   @id @default(cuid())
  productId String
  quantity  Int
  sessionId String
  expiresAt DateTime
  createdAt DateTime @default(now())
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([productId])
  @@index([sessionId])
}
// =============================================================================
// ORDER MODELS
// =============================================================================

model order_items {
  id        String   @id @default(cuid())
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  orderId   String
  productId String
  color     String?
  size      String?
  orders    orders   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  products  products @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model orders {
  id                   String               @id @default(cuid())
  customerName         String
  customerPhone        String
  customerAddress      String?
  total                Decimal              @db.Decimal(10, 2)
  status               OrderStatus          @default(PENDING)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  customerEmail        String?
  mpPaymentId          String?
  mpPreferenceId       String?
  mpStatus             String?
  trackingNumber       String?
  shippingMethod       String?
  estimatedDelivery    DateTime?
  shippingCost         Decimal?             @db.Decimal(10, 2)
  caTrackingNumber     String?              @unique
  caShipmentId         String?
  caExtOrderId         String?              @unique
  shippingAgency       String?
  shippingStreet       String?
  shippingNumber       String?
  shippingFloor        String?              @db.VarChar(3)
  shippingApartment    String?              @db.VarChar(3)
  shippingCity         String?
  shippingProvince     String?
  shippingPostalCode   String?
  caCustomerId         String?
  caOrderNumber        String?
  caShipmentId_rel     String?
  declaredValue        Decimal?             @db.Decimal(10, 2)
  estimatedDeliveryMax String?
  estimatedDeliveryMin String?
  ocaOrderId           String?
  ocaTrackingNumber    String?
  packageHeight        Int?
  packageLength        Int?
  packageWeight        Int?
  packageWidth         Int?
  rateValidTo          DateTime?
  recipientCellPhone   String?
  recipientEmail       String?
  recipientName        String?
  recipientPhone       String?
  senderApartment      String?              @db.VarChar(3)
  senderCellPhone      String?
  senderCity           String?
  senderEmail          String?
  senderFloor          String?              @db.VarChar(3)
  senderLocality       String?
  senderName           String?
  senderPhone          String?
  senderPostalCode     String?
  senderProvinceCode   String?              @db.Char(1)
  senderStreetName     String?
  senderStreetNumber   String?
  shippingLocality     String?
  shippingProductType  String?              @default("CP")
  shippingProvinceCode String?              @db.Char(1)
  caImportError        String?
  caImportStatus       String?
  order_items          order_items[]
  status_history       OrderStatusHistory[]
  ca_customers         ca_customers?        @relation(fields: [caCustomerId], references: [customerId])
  ca_shipments         ca_shipments?        @relation(fields: [caShipmentId_rel], references: [id])

  @@index([caCustomerId])
  @@index([caExtOrderId])
  @@index([caTrackingNumber])
  @@index([createdAt])
  @@index([mpPaymentId])
  @@index([mpPreferenceId])
  @@index([ocaTrackingNumber])
  @@index([shippingProvinceCode])
  @@index([status])
  @@index([trackingNumber])
  @@index([status, createdAt])
  @@index([customerEmail])
}

/// Tracks order status changes for timeline display
model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  notes     String?
  createdAt DateTime    @default(now())
  order     orders      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@index([orderId, createdAt])
}

// =============================================================================
// SETTINGS MODEL
// =============================================================================

model settings {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// =============================================================================
// ENUMS
// =============================================================================

enum CADeliveryType {
  D // Domicilio
  S // Sucursal
}

enum CADocumentType {
  DNI
  CUIT
}

enum OrderStatus {
  PENDING         // Pedido creado, esperando pago del cliente
  PENDING_PAYMENT // Cliente pagó, esperando que admin pague envío
  PROCESSED       // Envío pagado, listo para preparar y entregar
  DELIVERED       // Entregado al cliente
}
