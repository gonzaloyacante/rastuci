generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =============================================================================
// AUTHENTICATION & USER MODELS
// =============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SessionLog {
  id        String    @id @default(cuid())
  userId    String
  ipAddress String?
  userAgent String?
  loginAt   DateTime  @default(now())
  logoutAt  DateTime?
  isActive  Boolean   @default(true)
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([loginAt])
  @@index([userId])
}

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String?      @unique
  emailVerified DateTime?
  image         String?
  password      String?
  isAdmin       Boolean      @default(false)
  createdAt     DateTime     @default(now())
  lastLoginAt   DateTime?
  lastLoginIp   String?
  loginCount    Int          @default(0)
  updatedAt     DateTime     @updatedAt
  Account       Account[]
  Session       Session[]
  SessionLog    SessionLog[]

  @@index([email])
  @@index([isAdmin])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@index([expires])
}

// =============================================================================
// LEGAL & CONTENT MODELS
// =============================================================================

model LegalPolicy {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  content     Json? // Legacy JSON content
  htmlContent String? // New String content
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// =============================================================================
// ANALYTICS MODELS
// =============================================================================

model analytics_events {
  id                 String             @id @default(cuid())
  sessionId          String
  userId             String?
  eventName          String
  eventData          Json?
  pageUrl            String?
  referrer           String?
  deviceType         String?
  browser            String?
  os                 String?
  country            String?
  city               String?
  createdAt          DateTime           @default(now())
  analytics_sessions analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([eventName])
  @@index([sessionId])
  @@index([userId])
  @@index([eventName, createdAt])
}

model analytics_sessions {
  id               String             @id @default(cuid())
  userId           String?
  startedAt        DateTime           @default(now())
  endedAt          DateTime?
  pageViews        Int                @default(0)
  deviceType       String?
  browser          String?
  os               String?
  screenWidth      Int?
  screenHeight     Int?
  country          String?
  city             String?
  timezone         String?
  entryPage        String?
  exitPage         String?
  duration         Int?
  isConverted      Boolean            @default(false)
  conversionValue  Decimal?           @db.Decimal(10, 2)
  analytics_events analytics_events[]
  cart_abandonment cart_abandonment[]
  search_analytics search_analytics[]

  @@index([isConverted])
  @@index([startedAt])
  @@index([userId])
  @@index([isConverted, startedAt])
}

model search_analytics {
  id                  String             @id @default(cuid())
  sessionId           String
  userId              String?
  query               String
  resultsCount        Int?
  clickedProductId    String?
  clickPosition       Int?
  convertedToCart     Boolean            @default(false)
  convertedToPurchase Boolean            @default(false)
  createdAt           DateTime           @default(now())
  analytics_sessions  analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([query])
  @@index([sessionId])
  @@index([convertedToPurchase, createdAt])
}

model cart_abandonment {
  id                 String             @id @default(cuid())
  sessionId          String
  userId             String?
  cartItems          Json? // kept for migration
  // cartItems   Json // Deprecated, replaced by relation
  items              cart_abandonment_items[]
  cartValue          Decimal            @db.Decimal(10, 2)
  abandonedAt        DateTime           @default(now())
  lastStep           String?
  recoveredAt        DateTime?
  recoveryOrderId    String?
  emailSent          Boolean            @default(false)
  emailSentAt        DateTime?
  analytics_sessions analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([abandonedAt])
  @@index([recoveredAt])
  @@index([sessionId])
  @@index([userId])
  @@index([emailSent, abandonedAt])
}

model cart_abandonment_items {
  id            String           @id @default(cuid())
  abandonmentId String
  productId     String
  quantity      Int
  price         Decimal          @db.Decimal(10, 2)
  productName   String?
  variant       String? // JSON or String description of variant
  abandonment   cart_abandonment @relation(fields: [abandonmentId], references: [id], onDelete: Cascade)
  product       products         @relation(fields: [productId], references: [id])

  @@index([abandonmentId])
  @@index([productId])
}

// =============================================================================
// CORREO ARGENTINO MODELS
// =============================================================================

model ca_agencies {
  code               String   @id
  name               String
  manager            String?
  email              String?
  phone              String?
  packageReception   Boolean  @default(false)
  pickupAvailability Boolean  @default(false)
  streetName         String?
  streetNumber       String?
  floor              String?
  apartment          String?
  locality           String?
  city               String?
  province           String?
  provinceCode       String   @db.Char(1)
  postalCode         String?
  latitude           Float?
  longitude          Float?
  hours              Json?
  // hours     Json? // Deprecated, replaced by relation
  agency_hours       agency_hours[]
  status             String   @default("ACTIVE")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([city])
  @@index([provinceCode])
  @@index([status])
  @@index([postalCode])
}

model agency_hours {
  id         String      @id @default(cuid())
  agencyCode String
  day        String // Lunes, Martes, etc.
  open       String // HH:mm
  close      String // HH:mm
  agency     ca_agencies @relation(fields: [agencyCode], references: [code], onDelete: Cascade)

  @@index([agencyCode])
}

model ca_customers {
  customerId        String              @id
  firstName         String
  lastName          String
  email             String              @unique
  documentType      CADocumentType
  documentId        String              @unique
  phone             String?
  cellPhone         String?
  streetName        String?
  streetNumber      String?
  floor             String?
  apartment         String?
  locality          String?
  city              String?
  provinceCode      String?             @db.Char(1)
  postalCode        String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  ca_shipments      ca_shipments[]
  ca_shipping_rates ca_shipping_rates[]
  orders            orders[]

  @@index([documentId])
  @@index([email])
}

model ca_shipments {
  id                 String               @id @default(cuid())
  customerId         String
  extOrderId         String               @unique
  orderNumber        String?
  trackingNumber     String?              @unique
  productId          String?
  senderName         String?
  senderPhone        String?
  senderCellPhone    String?
  senderEmail        String?
  senderStreetName   String?
  senderStreetNumber String?
  senderFloor        String?
  senderApartment    String?
  senderLocality     String?
  senderCity         String?
  senderProvinceCode String?              @db.Char(1)
  senderPostalCode   String?
  recipientName      String
  recipientPhone     String?
  recipientCellPhone String?
  recipientEmail     String
  deliveryType       CADeliveryType
  productType        String
  agencyCode         String?
  destStreetName     String?
  destStreetNumber   String?
  destFloor          String?
  destApartment      String?
  destLocality       String?
  destCity           String?
  destProvinceCode   String?              @db.Char(1)
  destPostalCode     String?
  weight             Int
  height             Int
  width              Int
  length             Int
  declaredValue      Decimal              @db.Decimal(10, 2)
  status             String?
  importedAt         DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  ca_customers       ca_customers         @relation(fields: [customerId], references: [customerId])
  ca_tracking_events ca_tracking_events[]
  orders             orders[]

  @@index([customerId])
  @@index([extOrderId])
  @@index([status])
  @@index([trackingNumber])
  @@index([createdAt])
}

model ca_shipping_rates {
  id                    String         @id @default(cuid())
  customerId            String
  postalCodeOrigin      String
  postalCodeDestination String
  deliveryType          CADeliveryType
  productType           String
  productName           String
  weight                Int
  height                Int
  width                 Int
  length                Int
  price                 Decimal        @db.Decimal(10, 2)
  deliveryTimeMin       String
  deliveryTimeMax       String
  validTo               DateTime
  createdAt             DateTime       @default(now())
  ca_customers          ca_customers   @relation(fields: [customerId], references: [customerId])

  @@index([customerId])
  @@index([postalCodeDestination])
  @@index([postalCodeOrigin])
  @@index([validTo])
  @@index([postalCodeOrigin, postalCodeDestination])
}

model ca_tracking_events {
  id           String       @id @default(cuid())
  shipmentId   String
  event        String
  eventDate    DateTime
  branch       String
  status       String?
  sign         String?
  createdAt    DateTime     @default(now())
  ca_shipments ca_shipments @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([eventDate])
  @@index([event])
  @@index([shipmentId])
  @@index([shipmentId, eventDate])
}

// =============================================================================
// PRODUCT & CATEGORY MODELS
// =============================================================================

model categories {
  id          String     @id @default(cuid())
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  imageUrl    String?
  icon        String?
  isActive    Boolean    @default(true)
  products    products[]

  @@index([name])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model products {
  id                   String                 @id @default(cuid())
  name                 String
  description          String?
  price                Decimal                @db.Decimal(10, 2)
  stock                Int                    @default(0)
  images               String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  categoryId           String
  onSale               Boolean                @default(false)
  colors               String[]               @default([])
  features             String[]               @default([])
  rating               Float?                 @default(0)
  reviewCount          Int                    @default(0)
  sizes                String[]               @default([])
  salePrice            Decimal?               @db.Decimal(10, 2)
  weight               Int?                   @default(1000)
  height               Int?                   @default(10)
  width                Int?                   @default(20)
  length               Int?                   @default(30)
  isActive             Boolean                @default(true)
  // Legacy JSON fields - DEPRECATED, use relations instead
  sizeGuide            Json?
  colorImages          Json?
  // Relations
  order_items          order_items[]
  product_reviews      product_reviews[]
  product_variants     product_variants[]
  categories           categories             @relation(fields: [categoryId], references: [id])
  stock_reservations   stock_reservations[]
  product_color_images product_color_images[]
  product_size_guides  product_size_guides[]
  cart_abandonment_items cart_abandonment_items[]

  @@index([categoryId])
  @@index([categoryId, name])
  @@index([categoryId, onSale])
  @@index([categoryId, price])
  @@index([colors], type: Gin)
  @@index([createdAt])
  @@index([features], type: Gin)
  @@index([isActive])
  @@index([name])
  @@index([onSale])
  @@index([onSale, price])
  @@index([price])
  @@index([sizes], type: Gin)
  @@index([stock])
}

model product_variants {
  id        String   @id @default(cuid())
  productId String
  color     String
  size      String
  stock     Int      @default(0)
  sku       String?
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, color, size])
  @@index([productId])
  @@index([sku])
}

model product_reviews {
  id           String   @id @default(cuid())
  rating       Int      @db.SmallInt
  comment      String?
  customerName String
  createdAt    DateTime @default(now())
  productId    String
  products     products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([createdAt])
  @@index([rating])
}

model stock_reservations {
  id        String   @id @default(cuid())
  productId String
  quantity  Int
  sessionId String
  expiresAt DateTime
  createdAt DateTime @default(now())
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([productId])
  @@index([sessionId])
}

/// Product color-specific images (replaces JSON colorImages field)
model product_color_images {
  id        String   @id @default(cuid())
  productId String
  color     String
  imageUrl  String
  sortOrder Int      @default(0)
  products  products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([productId, color])
}

/// Product size guide measurements (replaces JSON sizeGuide field)
model product_size_guides {
  id           String   @id @default(cuid())
  productId    String
  size         String
  measurements String   // e.g., "Pecho: 40cm, Largo: 50cm"
  ageRange     String?  // e.g., "2-3 años"
  products     products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, size])
  @@index([productId])
}
// =============================================================================
// ORDER MODELS
// =============================================================================

model order_items {
  id        String   @id @default(cuid())
  quantity  Int
  price     Decimal  @db.Decimal(10, 2)
  orderId   String
  productId String
  color     String?
  size      String?
  orders    orders   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  products  products @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model orders {
  id                   String               @id @default(cuid())
  customerName         String
  customerPhone        String
  customerAddress      String?
  total                Decimal              @db.Decimal(10, 2)
  status               OrderStatus          @default(PENDING)
  paymentMethod        String?
  transferProofUrl     String?
  transferSenderName   String?
  transferTransactionId String?
  transferProofAt      DateTime?
  expiresAt            DateTime?
  paymentReminderSent  Boolean?             @default(false)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  customerEmail        String?
  mpPaymentId          String?
  mpPreferenceId       String?
  mpStatus             String?
  trackingNumber       String?
  shippingMethod       String?
  estimatedDelivery    DateTime?
  shippingCost         Decimal?             @db.Decimal(10, 2)
  caTrackingNumber     String?              @unique
  caShipmentId         String?
  caExtOrderId         String?              @unique
  shippingAgency       String?
  shippingStreet       String?
  shippingNumber       String?
  shippingFloor        String?              @db.VarChar(3)
  shippingApartment    String?              @db.VarChar(3)
  shippingCity         String?
  shippingProvince     String?
  shippingPostalCode   String?
  caCustomerId         String?
  caOrderNumber        String?
  caShipmentId_rel     String?
  declaredValue        Decimal?             @db.Decimal(10, 2)
  estimatedDeliveryMax String?
  estimatedDeliveryMin String?
  ocaOrderId           String?
  ocaTrackingNumber    String?
  packageHeight        Int?
  packageLength        Int?
  packageWeight        Int?
  packageWidth         Int?
  rateValidTo          DateTime?
  recipientCellPhone   String?
  recipientEmail       String?
  recipientName        String?
  recipientPhone       String?
  senderApartment      String?              @db.VarChar(3)
  senderCellPhone      String?
  senderCity           String?
  senderEmail          String?
  senderFloor          String?              @db.VarChar(3)
  senderLocality       String?
  senderName           String?
  senderPhone          String?
  senderPostalCode     String?
  senderProvinceCode   String?              @db.Char(1)
  senderStreetName     String?
  senderStreetNumber   String?
  shippingLocality     String?
  shippingProductType  String?              @default("CP")
  shippingProvinceCode String?              @db.Char(1)
  caImportError        String?
  caImportStatus       String?
  order_items          order_items[]
  status_history       OrderStatusHistory[]
  ca_customers         ca_customers?        @relation(fields: [caCustomerId], references: [customerId])
  ca_shipments         ca_shipments?        @relation(fields: [caShipmentId_rel], references: [id])

  @@index([caCustomerId])
  @@index([caExtOrderId])
  @@index([caTrackingNumber])
  @@index([createdAt])
  @@index([mpPaymentId])
  @@index([mpPreferenceId])
  @@index([ocaTrackingNumber])
  @@index([shippingProvinceCode])
  @@index([status])
  @@index([trackingNumber])
  @@index([status, createdAt])
  @@index([customerEmail])
}

/// Tracks order status changes for timeline display
model OrderStatusHistory {
  id        String      @id @default(cuid())
  orderId   String
  status    OrderStatus
  notes     String?
  createdAt DateTime    @default(now())
  order     orders      @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@index([orderId, createdAt])
}

// =============================================================================
// SETTINGS MODELS (Explicit - No JSON)
// =============================================================================

/// Store identity and email configuration
model store_settings {
  id                String   @id @default("default")
  name              String   @default("Rastuci")
  adminEmail        String?
  salesEmail        String?
  supportEmail      String?
  senderName        String?
  addressStreet     String?
  addressCity       String?
  addressProvince   String?
  addressPostalCode String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

/// Homepage visual configuration
model home_settings {
  id                   String          @id @default("default")
  headerLogoUrl        String?
  heroLogoUrl          String?
  heroImage            String?
  heroTitle            String          @default("Bienvenidos a Rastuci")
  heroSubtitle         String          @default("Ropa para niños con estilo")
  ctaPrimaryLabel      String          @default("Ver Productos")
  ctaSecondaryLabel    String          @default("Conocer Más")
  categoriesTitle      String          @default("Categorías")
  featuredTitle        String          @default("Ofertas Destacadas")
  featuredSubtitle     String          @default("Los mejores productos con descuento")
  showHeroLogo         Boolean         @default(true)
  showHeroTitle        Boolean         @default(true)
  showHeroSubtitle     Boolean         @default(true)
  showCtaPrimary       Boolean         @default(true)
  showCtaSecondary     Boolean         @default(true)
  showCategoriesTitle  Boolean         @default(true)
  showFeaturedTitle    Boolean         @default(true)
  showFeaturedSubtitle Boolean         @default(true)
  footerLogoUrl        String?
  footerBrand          String          @default("Rastuci")
  footerTagline        String          @default("Moda infantil con amor")
  showFooterLogo       Boolean         @default(true)
  showFooterBrand      Boolean         @default(true)
  showFooterTagline    Boolean         @default(true)
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  benefits             home_benefits[]
}

/// Homepage benefit items
model home_benefits {
  id             String        @id @default(cuid())
  homeSettingsId String        @default("default")
  icon           String        @default("Truck")
  title          String
  description    String
  sortOrder      Int           @default(0)
  home_settings  home_settings @relation(fields: [homeSettingsId], references: [id], onDelete: Cascade)

  @@index([homeSettingsId])
  @@index([sortOrder])
}

/// Contact page configuration
model contact_settings {
  id                 String   @id @default("default")
  headerTitle        String   @default("Contacto")
  headerSubtitle     String   @default("Estamos aquí para ayudarte")
  emails             String[] @default([])
  phones             String[] @default([])
  addressLine1       String?
  addressLine2       String?
  addressCityCountry String?
  hoursTitle         String   @default("Horarios de Atención")
  hoursWeekdays      String   @default("Lunes a Viernes: 9:00 - 18:00")
  hoursSaturday      String   @default("Sábados: 9:00 - 14:00")
  hoursSunday        String   @default("Domingos: Cerrado")
  formTitle          String   @default("Envíanos un mensaje")
  formNameLabel      String   @default("Nombre")
  formEmailLabel     String   @default("Email")
  formPhoneLabel     String   @default("Teléfono")
  formMessageLabel   String   @default("Mensaje")
  formSubmitLabel    String   @default("Enviar")
  formSuccessTitle   String   @default("¡Mensaje enviado!")
  formSuccessMessage String   @default("Te responderemos pronto")
  formSendAnother    String   @default("Enviar otro mensaje")
  instagramUrl       String?
  instagramUsername  String?
  facebookUrl        String?
  facebookUsername   String?
  whatsappUrl        String?
  whatsappUsername   String?
  tiktokUrl          String?
  tiktokUsername     String?
  youtubeUrl         String?
  youtubeUsername    String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

/// Stock/Inventory alert thresholds
model stock_settings {
  id                     String                @id @default("default")
  lowStockThreshold      Int                   @default(5)
  criticalStockThreshold Int                   @default(2)
  enableLowStockAlerts   Boolean               @default(true)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  statuses               stock_status_levels[]
}

model stock_status_levels {
  id              String           @id
  stockSettingsId String           @default("default")
  min             Int              @default(0)
  max             Int?
  label           String
  color           StockStatusColor @default(muted)
  sortOrder       Int              @default(0)
  stock_settings  stock_settings   @relation(fields: [stockSettingsId], references: [id], onDelete: Cascade)

  @@index([stockSettingsId])
}

/// Shipping configuration defaults
model shipping_settings {
  id                 String   @id @default("default")
  enableFreeShipping Boolean  @default(false)
  freeShippingMin    Decimal? @db.Decimal(10, 2)
  defaultCarrier     String   @default("correo_argentino")
  originPostalCode   String?
  originCity         String?
  originProvince     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

/// FAQ items (replaces JSON array in settings)
model faq_items {
  id        String   @id @default(cuid())
  question  String
  answer    String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, sortOrder])
}

/// Legacy settings table - DEPRECATED, will be removed after migration
/// @deprecated Use specific settings models instead
model settings {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// =============================================================================
// ENUMS
// =============================================================================

enum StockStatusColor {
  success
  warning
  error
  info
  muted
  primary
  secondary
  accent
}

enum CADeliveryType {
  D // Domicilio
  S // Sucursal
}

enum CADocumentType {
  DNI
  CUIT
}

enum OrderStatus {
  PENDING         // Pedido creado, incompleto (MP sin pagar)
  PENDING_PAYMENT // Esperando pago (MP)
  WAITING_TRANSFER_PROOF // Esperando comprobante (Transferencia)
  PAYMENT_REVIEW  // Comprobante subido, esperando aprobación Admin
  RESERVED        // Reservado (Efectivo) - Stock retenido
  PROCESSED       // Pagado / Listo para preparar
  DELIVERED       // Entregado
  CANCELLED       // Cancelado / Rechazado
}
