generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                String    @id
  name              String?
  email             String?   @unique
  emailVerified     DateTime?
  image             String?
  password          String?
  isAdmin           Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?
  lastLoginIp       String?
  loginCount        Int       @default(0)
  Account           Account[]
  Session           Session[]
  SessionLog        SessionLog[]
}

model SessionLog {
  id          String   @id @default(cuid())
  userId      String
  ipAddress   String?
  userAgent   String?
  loginAt     DateTime @default(now())
  logoutAt    DateTime?
  isActive    Boolean  @default(true)
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model ca_agencies {
  code               String   @id
  name               String
  manager            String?
  email              String?
  phone              String?
  packageReception   Boolean  @default(false)
  pickupAvailability Boolean  @default(false)
  streetName         String?
  streetNumber       String?
  floor              String?
  apartment          String?
  locality           String?
  city               String?
  province           String?
  provinceCode       String   @db.Char(1)
  postalCode         String?
  latitude           Float?
  longitude          Float?
  hours              Json?
  status             String   @default("ACTIVE")
  createdAt          DateTime @default(now())
  updatedAt          DateTime

  @@index([city])
  @@index([provinceCode])
  @@index([status])
}

model ca_customers {
  customerId        String              @id
  firstName         String
  lastName          String
  email             String              @unique
  documentType      CADocumentType
  documentId        String              @unique
  phone             String?
  cellPhone         String?
  streetName        String?
  streetNumber      String?
  floor             String?
  apartment         String?
  locality          String?
  city              String?
  provinceCode      String?             @db.Char(1)
  postalCode        String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime
  ca_shipments      ca_shipments[]
  ca_shipping_rates ca_shipping_rates[]
  orders            orders[]

  @@index([documentId])
  @@index([email])
}

model ca_shipments {
  id                 String               @id
  customerId         String
  extOrderId         String               @unique
  orderNumber        String?
  trackingNumber     String?              @unique
  productId          String?
  senderName         String?
  senderPhone        String?
  senderCellPhone    String?
  senderEmail        String?
  senderStreetName   String?
  senderStreetNumber String?
  senderFloor        String?
  senderApartment    String?
  senderLocality     String?
  senderCity         String?
  senderProvinceCode String?              @db.Char(1)
  senderPostalCode   String?
  recipientName      String
  recipientPhone     String?
  recipientCellPhone String?
  recipientEmail     String
  deliveryType       CADeliveryType
  productType        String
  agencyCode         String?
  destStreetName     String?
  destStreetNumber   String?
  destFloor          String?
  destApartment      String?
  destLocality       String?
  destCity           String?
  destProvinceCode   String?              @db.Char(1)
  destPostalCode     String?
  weight             Int
  height             Int
  width              Int
  length             Int
  declaredValue      Float
  status             String?
  importedAt         DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  ca_customers       ca_customers         @relation(fields: [customerId], references: [customerId])
  ca_tracking_events ca_tracking_events[]
  orders             orders[]

  @@index([customerId])
  @@index([extOrderId])
  @@index([status])
  @@index([trackingNumber])
}

model ca_shipping_rates {
  id                    String         @id
  customerId            String
  postalCodeOrigin      String
  postalCodeDestination String
  deliveryType          CADeliveryType
  productType           String
  productName           String
  weight                Int
  height                Int
  width                 Int
  length                Int
  price                 Float
  deliveryTimeMin       String
  deliveryTimeMax       String
  validTo               DateTime
  createdAt             DateTime       @default(now())
  ca_customers          ca_customers   @relation(fields: [customerId], references: [customerId])

  @@index([customerId])
  @@index([postalCodeDestination])
  @@index([postalCodeOrigin])
  @@index([validTo])
}

model ca_tracking_events {
  id           String       @id
  shipmentId   String
  event        String
  eventDate    DateTime
  branch       String
  status       String?
  sign         String?
  createdAt    DateTime     @default(now())
  ca_shipments ca_shipments @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([eventDate])
  @@index([event])
  @@index([shipmentId])
}

model categories {
  id          String     @id
  name        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  imageUrl    String?
  icon        String?
  products    products[]
}

model order_items {
  id        String   @id
  quantity  Int
  price     Float
  orderId   String
  productId String
  color     String?
  size      String?
  orders    orders   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  products  products @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model orders {
  id                   String        @id
  customerName         String
  customerPhone        String
  customerAddress      String?
  total                Float
  status               OrderStatus   @default(PENDING)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime
  customerEmail        String?
  mpPaymentId          String?
  mpPreferenceId       String?
  mpStatus             String?
  caTrackingNumber     String?       @unique
  caShipmentId         String?
  caExtOrderId         String?       @unique
  caImportStatus       String?
  caImportError        String?
  shippingAgency       String?
  shippingStreet       String?
  shippingNumber       String?
  shippingFloor        String?       @db.VarChar(3)
  shippingApartment    String?       @db.VarChar(3)
  shippingCity         String?
  shippingProvince     String?
  shippingPostalCode   String?
  trackingNumber       String?
  ocaTrackingNumber    String?
  ocaOrderId           String?
  shippingMethod       String?
  estimatedDelivery    DateTime?
  shippingCost         Float?
  caCustomerId         String?
  caOrderNumber        String?
  caShipmentId_rel     String?
  declaredValue        Float?
  estimatedDeliveryMax String?
  estimatedDeliveryMin String?
  packageHeight        Int?
  packageLength        Int?
  packageWeight        Int?
  packageWidth         Int?
  rateValidTo          DateTime?
  recipientCellPhone   String?
  recipientEmail       String?
  recipientName        String?
  recipientPhone       String?
  senderApartment      String?       @db.VarChar(3)
  senderCellPhone      String?
  senderCity           String?
  senderEmail          String?
  senderFloor          String?       @db.VarChar(3)
  senderLocality       String?
  senderName           String?
  senderPhone          String?
  senderPostalCode     String?
  senderProvinceCode   String?       @db.Char(1)
  senderStreetName     String?
  senderStreetNumber   String?
  shippingLocality     String?
  shippingProductType  String?       @default("CP")
  shippingProvinceCode String?       @db.Char(1)
  order_items          order_items[]
  ca_customers         ca_customers? @relation(fields: [caCustomerId], references: [customerId])
  ca_shipments         ca_shipments? @relation(fields: [caShipmentId_rel], references: [id])

  @@index([caCustomerId])
  @@index([caExtOrderId])
  @@index([caTrackingNumber])
  @@index([createdAt])
  @@index([ocaTrackingNumber])
  @@index([shippingProvinceCode])
  @@index([status])
  @@index([trackingNumber])
}

model product_reviews {
  id           String   @id
  rating       Int      @db.SmallInt
  comment      String?
  customerName String
  createdAt    DateTime @default(now())
  productId    String
  products     products @relation(fields: [productId], references: [id], onDelete: Cascade)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model products {
  id              String            @id
  name            String
  description     String?
  price           Float
  stock           Int               @default(0)
  images          String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  categoryId      String
  onSale          Boolean           @default(false)
  colors          String[]          @default([])
  features        String[]          @default([])
  rating          Float?            @default(0)
  reviewCount     Int               @default(0)
  sizes           String[]          @default([])
  salePrice       Float?
  weight          Int?              @default(1000)
  height          Int?              @default(10)
  width           Int?              @default(20)
  length          Int?              @default(30)
  sizeGuide       Json?
  colorImages     Json?             // Mapa de Color -> URLs de imágenes { "Azul": ["url1", "url2"] }
  variants        product_variants[]
  order_items        order_items[]
  product_reviews    product_reviews[]
  stock_reservations stock_reservations[]
  categories         categories           @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([categoryId, onSale])
  @@index([createdAt])
  @@index([name])
  @@index([onSale])
  @@index([price])
  @@index([stock])
}

model product_variants {
  id        String   @id @default(cuid())
  productId String
  color     String
  size      String
  stock     Int      @default(0)
  sku       String?
  product   products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, color, size])
  @@index([productId])
}

model settings {
  key       String   @id
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model stock_reservations {
  id         String   @id @default(cuid())
  productId  String
  quantity   Int
  sessionId  String   // ID único de la sesión de checkout
  expiresAt  DateTime // Expiración de la reserva (15 min)
  createdAt  DateTime @default(now())
  product    products @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([sessionId])
  @@index([expiresAt])
}

// =============================================================================
// ANALYTICS MODELS
// =============================================================================

model analytics_events {
  id         String   @id @default(cuid())
  sessionId  String
  userId     String?
  eventName  String
  eventData  Json?
  pageUrl    String?
  referrer   String?
  deviceType String?  // desktop, mobile, tablet
  browser    String?
  os         String?
  country    String?
  city       String?
  createdAt  DateTime @default(now())

  session    analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([eventName])
  @@index([createdAt])
  @@index([userId])
}

model analytics_sessions {
  id              String    @id
  userId          String?
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  pageViews       Int       @default(0)
  deviceType      String?
  browser         String?
  os              String?
  screenWidth     Int?
  screenHeight    Int?
  country         String?
  city            String?
  timezone        String?
  entryPage       String?
  exitPage        String?
  duration        Int?      // in seconds
  isConverted     Boolean   @default(false)
  conversionValue Float?
  
  events          analytics_events[]
  searchQueries   search_analytics[]
  abandonedCarts  cart_abandonment[]

  @@index([userId])
  @@index([startedAt])
  @@index([isConverted])
}

model search_analytics {
  id              String   @id @default(cuid())
  sessionId       String
  userId          String?
  query           String
  resultsCount    Int?
  clickedProductId String?
  clickPosition   Int?
  convertedToCart Boolean  @default(false)
  convertedToPurchase Boolean @default(false)
  createdAt       DateTime @default(now())

  session         analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([query])
  @@index([createdAt])
}

model cart_abandonment {
  id              String    @id @default(cuid())
  sessionId       String
  userId          String?
  cartItems       Json      // Array of { productId, name, quantity, price, color, size }
  cartValue       Float
  abandonedAt     DateTime  @default(now())
  lastStep        String?   // 'cart', 'shipping', 'payment'
  recoveredAt     DateTime?
  recoveryOrderId String?
  emailSent       Boolean   @default(false)
  emailSentAt     DateTime?

  session         analytics_sessions @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([abandonedAt])
  @@index([recoveredAt])
  @@index([userId])
}

enum CADeliveryType {
  D
  S
}

enum CADocumentType {
  DNI
  CUIT
}

enum CAProvinceCode {
  A
  B
  C
  D
  E
  F
  G
  H
  J
  K
  L
  M
  N
  P
  Q
  R
  S
  T
  U
  V
  W
  X
  Y
  Z
}

enum OrderStatus {
  PENDING           // Pedido creado, esperando pago del cliente
  PENDING_PAYMENT   // Cliente pagó, esperando que admin pague envío en MiCorreo
  PROCESSED         // Envío pagado, listo para preparar y entregar
  DELIVERED         // Entregado al cliente
}
